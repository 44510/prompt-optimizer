# 版本更新系统修复任务清单

按优先级组织的修复任务列表。

## 🚨 高优先级任务

### 1. 后端忽略版本存储结构修复
**目标**: 支持同时忽略正式版和预览版的不同版本
**预计时间**: 2-3小时
**文件**: `packages/desktop/main.js`, `packages/desktop/config/constants.js`

#### 具体任务
- [x] 修改存储结构从单一字符串改为对象结构
- [x] 更新 `PREFERENCE_KEYS` 常量定义
- [x] 修改 `update-available` 事件处理逻辑
- [x] 修改 `UPDATE_IGNORE_VERSION` IPC处理器
- [x] 添加向后兼容性处理（迁移旧数据）
- [ ] 测试新的忽略逻辑

### 2. 前端忽略版本状态管理修复
**目标**: 忽略版本后正确重置所有相关状态
**预计时间**: 1-2小时
**文件**: `packages/ui/src/composables/useUpdater.ts`

#### 具体任务
- [x] 修改 `ignoreUpdate` 函数支持版本类型参数
- [x] 添加对应状态重置逻辑
- [x] 修改 `handleIgnoreStableUpdate` 和 `handleIgnorePrereleaseUpdate`
- [x] 确保 `hasUpdate` 状态正确重新计算
- [ ] 测试忽略操作后的状态变化

## 🟡 中优先级任务

### 3. hasUpdate计算逻辑优化
**目标**: 根据用户偏好设置合理计算更新状态
**预计时间**: 1小时
**文件**: `packages/ui/src/composables/useUpdater.ts`

#### 具体任务
- [x] 创建 `calculateHasUpdate` 函数
- [x] 在 `checkBothVersions` 中使用新的计算逻辑
- [x] 考虑用户的 `allowPrerelease` 设置
- [ ] 测试不同偏好设置下的更新提示

### 4. 忽略按钮显示条件优化
**目标**: 只在真正有更新时显示忽略按钮
**预计时间**: 30分钟
**文件**: `packages/ui/src/components/UpdaterModal.vue`

#### 具体任务
- [x] 添加 `v-if` 条件到正式版忽略按钮
- [x] 添加 `v-if` 条件到预览版忽略按钮
- [ ] 测试按钮显示逻辑

## 🟢 低优先级任务

### 5. 异常处理保护
**目标**: 确保设置修改有完整的异常保护
**预计时间**: 30分钟
**文件**: `packages/ui/src/composables/useUpdater.ts`

#### 具体任务
- [x] 在 `checkSpecificVersion` 中添加 try-finally 保护
- [x] 确保偏好设置在异常时能正确恢复
- [ ] 测试异常情况下的设置恢复

### 6. 错误恢复机制完善
**目标**: 改进更新过程中的错误处理
**预计时间**: 1小时
**文件**: `packages/ui/src/composables/useUpdater.ts`

#### 具体任务
- [ ] 完善下载错误后的状态重置
- [ ] 改进错误消息显示
- [ ] 添加重试机制（可选）

## 📋 测试任务

### 功能测试
- [x] 基础构建和启动测试 ✅
- [ ] 测试同时忽略正式版和预览版
- [ ] 测试忽略后图标状态变化
- [ ] 测试不同用户偏好下的更新提示
- [ ] 测试按钮显示逻辑
- [ ] 测试异常情况下的恢复

### 回归测试
- [x] 应用启动功能 ✅
- [ ] 测试现有更新检查功能
- [ ] 测试下载功能
- [ ] 测试安装功能
- [ ] 测试设置切换功能

## 📊 任务状态追踪

### 总体进度
- **总任务数**: 6个主要任务
- **已完成**: 5个主要任务（代码实现完成）
- **进行中**: 1个（测试验证）
- **完成率**: 83%

### 本周目标
1. 完成后端存储结构修复
2. 完成前端状态管理修复
3. 开始UI逻辑优化

### 本月目标
1. 完成所有高优先级任务
2. 完成中优先级任务
3. 进行全面功能测试

## 🎯 下一步行动

### 立即开始
1. 分析当前后端存储结构
2. 设计新的存储格式
3. 实施后端修改

### 风险评估
- **高风险**: 后端存储结构修改（需要向后兼容）
- **中风险**: 前端状态管理修改（可能影响现有功能）
- **低风险**: UI逻辑优化（主要是显示条件）

---

**创建时间**: 2025-01-11  
**最后更新**: 2025-01-11  
**维护者**: AI Assistant
